package bridge

import (
	"crypto/ecdsa"
	"encoding/hex"
	"encoding/json"
	"errors"
	"fmt"
	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/accounts/abi/bind"
	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/incognitochain/bridge-eth/bridge/blur"
	"github.com/incognitochain/bridge-eth/bridge/opensea"
	"github.com/stretchr/testify/require"
	"github.com/stretchr/testify/suite"
	"log"
	"math/big"
	"os/exec"
	"strings"
	"testing"
)

// // Define the suite, and absorb the built-in basic suite
// // functionality from testify - including assertion methods.
type PBlurIntegrationTestSuite struct {
	*TradingTestSuite

	Forwarder     *opensea.Opensea
	BlurProxy     *blur.Blur
	BlurProxyAddr common.Address
	Blur1         *blur.BlurInterface
	Blur2         *blur.BlurInterface
	auth          *bind.TransactOpts
	EtherAddress  common.Address
	ETHHost       string
	ETHClient     *ethclient.Client
	IncHost       string
	ETHPrivKey    *ecdsa.PrivateKey
}

func NewPBlurIntegrationTestSuite(tradingTestSuite *TradingTestSuite) *PBlurIntegrationTestSuite {
	return &PBlurIntegrationTestSuite{
		TradingTestSuite: tradingTestSuite,
	}
}

// Make sure that VariableThatShouldStartAtFive is set to five
// before each test
func (v2 *PBlurIntegrationTestSuite) SetupSuite() {
	fmt.Println("Setting up the suite...")

	err := exec.Command("/bin/bash", "-c",
		"solc @openzeppelin/=node_modules/@openzeppelin/ --base-path=$(pwd)/bridge --bin --abi --optimize --overwrite bridge/contracts/blur/orderStructs.sol -o bridge/blur").Run()
	require.Equal(v2.T(), nil, err)
	err = exec.Command("/bin/bash", "-c",
		"abigen --abi bridge/blur/BuyBlurProxy.abi --bin bridge/blur/BuyBlurProxy.bin --out bridge/blur/blur.go --pkg blur").Run()

	v2.IncHost = "http://127.0.0.1:9338"
	v2.ETHHost = "http://127.0.0.1:8545"
	client, err := ethclient.Dial(v2.ETHHost)
	require.Equal(v2.T(), nil, err)
	v2.ETHClient = client

	// execute BulkExecute Execute
	blur1, err := blur.NewBlurInterface(common.HexToAddress("0x000000000000Ad05Ccc4F10045630fb830B95127"), v2.ETHClient)
	require.Equal(v2.T(), nil, err)
	v2.Blur1 = blur1

	// execute BatchBuyWithERC20s BatchBuyWithETH
	blur2, err := blur.NewBlurInterface(common.HexToAddress("0x39da41747a83aee658334415666f3ef92dd0d541"), v2.ETHClient)
	require.Equal(v2.T(), nil, err)
	v2.Blur2 = blur2

	privKey, err := crypto.HexToECDSA(v2.ETHPrivKeyStr)
	require.Equal(v2.T(), nil, err)
	v2.ETHPrivKey = privKey

	auth, err := bind.NewKeyedTransactorWithChainID(v2.ETHPrivKey, big.NewInt(int64(v2.ChainIDETH)))
	require.Equal(v2.T(), nil, err)

	// deploy forwarder
	_, _, fwd, err := opensea.DeployOpensea(auth, v2.ETHClient)
	require.Equal(v2.T(), nil, err)
	v2.Forwarder = fwd

	// deploy blur proxy
	bPAddr, _, bProxy, err := blur.DeployBlur(auth, v2.ETHClient)
	fmt.Println(bPAddr.String())
	require.Equal(v2.T(), nil, err)
	v2.BlurProxy = bProxy
	v2.BlurProxyAddr = bPAddr
}

func (v2 *PBlurIntegrationTestSuite) TearDownSuite() {
	fmt.Println("Tearing down the suite...")
}

func (v2 *PBlurIntegrationTestSuite) SetupTest() {
	fmt.Println("Setting up the test...")
}

func (v2 *PBlurIntegrationTestSuite) TearDownTest() {
	fmt.Println("Tearing down the test...")
}

// In order for 'go test' to run this suite, we need to create
// a normal test function and pass our suite to suite.Run
func TestPBlurIntegration(t *testing.T) {
	fmt.Println("Starting entry point for pdao test suite...")
	tradingSuite := new(TradingTestSuite)
	suite.Run(t, tradingSuite)

	uniswapTradingSuite := NewPBlurIntegrationTestSuite(tradingSuite)
	suite.Run(t, uniswapTradingSuite)

	fmt.Println("Finishing entry point for pdao test suite...")
}

func (v2 *PBlurIntegrationTestSuite) TestPBlurCreateProp() {
	auth, err := bind.NewKeyedTransactorWithChainID(v2.ETHPrivKey, big.NewInt(int64(v2.ChainIDETH)))
	require.Equal(v2.T(), nil, err)

	calldataStr := "9a2b81150000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000a8000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000005543df729c000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000009a409c5eabe0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000094487201b4100000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000006e0000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000000000000000007a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000005543df729c0000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000005a00000000000000000000000007ce5042d02394f1797d98bb3cba131e8ffbdecd5000000000000000000000000004c00500000ad104d7dbd00e3ae0a5c00560c0000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000636f49130000000000000000000000000000000000000000000000000000000063e5f014000000000000000000000000000000000000000000000000000000000000000072db8c0b000000000000000000000000000000000000000095394467fcf40e580000007b02230091a7ed01230072f7006a004d60a8d4e71d599b8104250f000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000025ddd361ab3649f331b578c0efd35d7242ffb90a0000000000000000000000000000000000000000000000000000000000001bbd0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004a9b6384488000000000000000000000000000000000000000000000000000004a9b6384488000000000000000000000000007ce5042d02394f1797d98bb3cba131e8ffbdecd50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000221b262dd8000000000000000000000000000000000000000000000000000000221b262dd8000000000000000000000000000000a26b00c1f0df003000390027140000faa7190000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000886c98b760000000000000000000000000000000000000000000000000000000886c98b76000000000000000000000000000157da9bd63ccaf6801c2c16223da87e18f7f1ae200000000000000000000000000000000000000000000000000000000000000419f60ff1f3e36b9e8203b874aa6aa6d546e1a3e54dca364b49e3d79124b7f047e57b50e25e54af31741c010c5f23a5ac97ef57f47c5e1f0d49cdd03e597cafdf91c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000070000000000000000000000000000000000000000000000000003e871b540c000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000007e4f7fc708b000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000003e871b540c00000000000000000000000000025ddd361ab3649f331b578c0efd35d7242ffb90a0000000000000000000000000000000000000000000000000000000000fa10b1000000000000000000000000000000000000000000000000000000000000001c3ea5fde93a60ff60e1e1b862ae8e3505d39b423f4a77e36246def24cd37164de227e30afee0a641badf97fc6b9fc07404ca730e68b66ef42df908ed03bbb1bb600000000000000000000000000000000000000000000000000000000000006649a1fc3a70000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000001c18b3c01aed34d2883d521cf96525eb2e1b7f8035d04490a4db93967f1d19305644f26ed0a5484cb555a4879f276e02f99098dd2c249f1716ee8e452dc0382c1f00000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b26a76fb5da1a3cd337bc11be8b0222d2ab16e91000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000025ddd361ab3649f331b578c0efd35d7242ffb90a0000000000000000000000000000000000000000000000000000000000001af1000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003e871b540c00000000000000000000000000000000000000000000000000000000000636f380a00000000000000000000000000000000000000000000000000000000645c860a00000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000008b0960ae60c0db3268a8f4e575208c4f00000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000102b8f4f3ba63d344c7cd57031095d1cb5f00a424a018c38d3c5619ba0a15c3d900000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000039da41747a83aee658334415666f3ef92dd0d541000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000025ddd361ab3649f331b578c0efd35d7242ffb90a0000000000000000000000000000000000000000000000000000000000001af1000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003e871b540c00000000000000000000000000000000000000000000000000000000000636f380b0000000000000000000000000000000000000000000000000000000063bf978f00000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000f1b2a9d3def2f33c9e499add05ecf33a00000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000001af100000000000000000000000000000000000000000000000000000000"
	calldata, _ := hex.DecodeString(calldataStr)
	iBlurProxyAbi, _ := abi.JSON(strings.NewReader(blur.BlurInterfaceMetaData.ABI))
	if method, ok := iBlurProxyAbi.Methods["batchBuyWithETH"]; ok {
		params, err := method.Inputs.Unpack(calldata[4:])
		if err != nil {
			log.Fatal(err)
		}
		fmt.Printf("execute: %+v\n", params)
	}
	recipient := common.HexToAddress("0x126748A0144968DD14b0187B906dE62378c59067")

	// 0.186 eth
	// buy 1 item blur
	calldataStr = "9a1fc3a70000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000001c59fba8503c29bdf06093e5fe8859c5f731b941b22b821a1d1d2c8b819188107867a61b4e9bddad2de52a3bcea34bb4f67412140e451b492e06a1c9c1e471201e00000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000033569c101562e1faf5b24581057e5cee4c8288d7000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000006411739da1c40b106f8511de5d1fac0000000000000000000000001dc5d3b2162f9500d7ddec14eb0ba9ccb43bc20c0000000000000000000000000000000000000000000000000000000000001f2200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005543df729c000000000000000000000000000000000000000000000000000000000000635275a300000000000000000000000000000000000000000000000000000000643fc3a300000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000004b6bde3512770e2134c5f02df5efe97a000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000064000000000000000000000000e0d0c735a5779919363db1deee102fa5536c93fe000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000587ff00d88a35dea6f9dcf644f418411cbe4bade1d1d59c4777bb8e110e15293330058e059bd7387157c269c2456a0ca94ca62752383463cbd5fd12c1ce9c9f2680316c28eb307dd37796e390f28eade9470faca2946339f6942edd413f56d4498eef8711a1eed481e792ff879687cb21628907e4044f2cdab720e6c7833a6c6ecc8a794bed6be0d905fb59ea5ba0e7366d22f41754038ede4f8e36ab90e67b1300000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ea8d6a16ba2a4593a461acddbfa7fa656132c61c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006411739da1c40b106f8511de5d1fac0000000000000000000000001dc5d3b2162f9500d7ddec14eb0ba9ccb43bc20c0000000000000000000000000000000000000000000000000000000000001f2200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005543df729c000000000000000000000000000000000000000000000000000000000000635275a40000000000000000000000000000000000000000000000000000000063c44a2a00000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000474962402c4aa8fa49a632032e7286a800000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
	calldata, _ = hex.DecodeString(calldataStr)
	var sell *blur.Input
	var buy *blur.Input
	if method, ok := iBlurProxyAbi.Methods["execute"]; ok {
		params, err := method.Inputs.Unpack(calldata[4:])
		if err != nil {
			log.Fatal(err)
		}
		sell, err = ParseInput(params[0])
		require.Equal(v2.T(), nil, err)

		buy, err = ParseInput(params[1])
		require.Equal(v2.T(), nil, err)
	}
	value, ok := big.NewInt(0).SetString("24000000000000000", 10)
	require.Equal(v2.T(), true, ok)
	auth.Value = value

	blurProxy, _ := abi.JSON(strings.NewReader(blur.BlurMetaData.ABI))
	buy.Order.Trader = v2.BlurProxyAddr
	callDataBlur, err := blurProxy.Pack("execute", sell, buy, recipient)
	require.Equal(v2.T(), nil, err)
	_, err = v2.Forwarder.Forward(auth, v2.BlurProxyAddr, callDataBlur)
	require.Equal(v2.T(), nil, err)
	forwardAbi, _ := abi.JSON(strings.NewReader(opensea.OpenseaMetaData.ABI))
	calldata, err = forwardAbi.Pack("forward", v2.BlurProxyAddr, callDataBlur)
	require.Equal(v2.T(), nil, err)
	fmt.Printf("final build call data 1 item blur: %v \n\n", hex.EncodeToString(calldata))

	// buy n items blur
	calldataStr = "b3be57f80000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000ea000000000000000000000000000000000000000000000000000000000000015a00000000000000000000000000000000000000000000000000000000000001cc00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000001b0cf5e81eb7ade405e283e7e7fdb005a370d7882b1f35bec2f54118daa07b941c2c906ba9c96de618f8c5565bb7e3f60ac1b3b9dabf2a581bcb538743c85aa02d00000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000073be3aed9d56b60d340b678ea789c58654f8c837000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000074211ca76d4cdd26c143e8ffd74469a04ae4e43b00000000000000000000000000000000000000000000000000000000000009d800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000635985c6000000000000000000000000000000000000000000000000000000006446d3c600000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000f73b9c29a61a9000c1b0191d9905fb180000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000b07952a55bf9c45c268f37c3631823df50ac721a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004b02c7f222976821683ced1a110ff97b1fbad92b997b49e9fa165b0152eae34203a77440f3215ddbd9c1729bdda3b4b96e31e6ccb282dab6640a6cd1c955e49fb93b2b39398ed2e024a5ec8848044fad2bd69e18a7ccb52a8f54cadaf0c63a6ab9bf0f718a614550c8bbd2d8099e0ef689c1052fb732570acc44a1b464fd46a7b00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004b57d5b27ba8d2936ca6e59830fcd968cddaab16000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000074211ca76d4cdd26c143e8ffd74469a04ae4e43b00000000000000000000000000000000000000000000000000000000000009d800000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000635985c70000000000000000000000000000000000000000000000000000000063c394cf00000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000f44f020dcd03e80b909a901086774beb00000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000001b0cf5e81eb7ade405e283e7e7fdb005a370d7882b1f35bec2f54118daa07b941c2c906ba9c96de618f8c5565bb7e3f60ac1b3b9dabf2a581bcb538743c85aa02d00000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000073be3aed9d56b60d340b678ea789c58654f8c837000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000074211ca76d4cdd26c143e8ffd74469a04ae4e43b0000000000000000000000000000000000000000000000000000000000000a5000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000635985c6000000000000000000000000000000000000000000000000000000006446d3c600000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000c44f6482ccdd1ed812fe7d1be8e170110000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000b07952a55bf9c45c268f37c3631823df50ac721a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004e24db8b204d3983985521b5cc27b8d31a0191d9b6a1bf153cb8d3d0b2eb1e143abb9a8563fa2750a39a1322360c5ac91eebea365c3b52d520e1a608fb8daa09b93b2b39398ed2e024a5ec8848044fad2bd69e18a7ccb52a8f54cadaf0c63a6ab9bf0f718a614550c8bbd2d8099e0ef689c1052fb732570acc44a1b464fd46a7b00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004b57d5b27ba8d2936ca6e59830fcd968cddaab16000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000074211ca76d4cdd26c143e8ffd74469a04ae4e43b0000000000000000000000000000000000000000000000000000000000000a5000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000635985c70000000000000000000000000000000000000000000000000000000063c394cf00000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000d60e29a3bfb18fe4fcef9985202980900000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000042000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000001baecec38157e42ff0077f66635c582f7d112522212dcfa9571e3259b75d9c6d4f1c226e830766c4a4e6a05e798c98a94ce1d92752be1c27e9baae2d11a04400a0000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffba913bb056544b75e57312ec3eae2528c285e1000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000074211ca76d4cdd26c143e8ffd74469a04ae4e43b0000000000000000000000000000000000000000000000000000000000000e5a0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000205466db74c0000000000000000000000000000000000000000000000000000000000063548404000000000000000000000000000000000000000000000000000000006441d20400000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000c13decb05776bc50df4e18623ec8f2560000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000b07952a55bf9c45c268f37c3631823df50ac721a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000004fd4db08f8502bfcb533cad335a5f894e5b0acca080b3feb6b810f222efb1dd5d6a6c264de7bfda8bd623499a992330751a1e7006cb3be3fdf8f7b13102e5f7a6a1f99ac00f780c89c3faca34d19f501acc0d7b6fc462341c1c4344accabc3592c816ff7ca4da3bead0ce12afb62f37e348f0843d006a3fd7ba9911efb3bf4bcb00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004b57d5b27ba8d2936ca6e59830fcd968cddaab16000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000074211ca76d4cdd26c143e8ffd74469a04ae4e43b0000000000000000000000000000000000000000000000000000000000000e5a0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000205466db74c00000000000000000000000000000000000000000000000000000000000635484050000000000000000000000000000000000000000000000000000000063c394cf00000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000e9efc0ea264dc0b2ed0094d28cb529e500000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000001baecec38157e42ff0077f66635c582f7d112522212dcfa9571e3259b75d9c6d4f1c226e830766c4a4e6a05e798c98a94ce1d92752be1c27e9baae2d11a04400a0000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffba913bb056544b75e57312ec3eae2528c285e1000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000074211ca76d4cdd26c143e8ffd74469a04ae4e43b0000000000000000000000000000000000000000000000000000000000000e730000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000205466db74c0000000000000000000000000000000000000000000000000000000000063548404000000000000000000000000000000000000000000000000000000006441d20400000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000ed634a9492bf69f2e42df9c0853a7e5f0000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000b07952a55bf9c45c268f37c3631823df50ac721a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000056854060682a9699501396172efb71e350ec9c144491380279bce6ddc9a7c83a606e7e0473c5f26b658809d2966325e554be1fcfec1fa2b680fc89da1d87b36599f312abb1818790f5b60b8bb79037bf2ffa78642e72fcc76db57afc933c162294061321a12ff655a4e44434aa331819b11881f25aeb3e4a31d6397c93d9c13b251916f8b2014a4a8846229a86f06d755dc2b790d6067101d079e453b92b58e3100000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004b57d5b27ba8d2936ca6e59830fcd968cddaab16000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000074211ca76d4cdd26c143e8ffd74469a04ae4e43b0000000000000000000000000000000000000000000000000000000000000e730000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000205466db74c00000000000000000000000000000000000000000000000000000000000635484050000000000000000000000000000000000000000000000000000000063c394cf00000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000e9632c940bc8e533eda70dfbc43cb6bb00000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000001baecec38157e42ff0077f66635c582f7d112522212dcfa9571e3259b75d9c6d4f1c226e830766c4a4e6a05e798c98a94ce1d92752be1c27e9baae2d11a04400a0000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffba913bb056544b75e57312ec3eae2528c285e1000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000074211ca76d4cdd26c143e8ffd74469a04ae4e43b0000000000000000000000000000000000000000000000000000000000000e830000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000205466db74c0000000000000000000000000000000000000000000000000000000000063548404000000000000000000000000000000000000000000000000000000006441d20400000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000e5767d63bf6585fd15979641c83238630000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000b07952a55bf9c45c268f37c3631823df50ac721a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000005c1f9d969628c8d9dc7f0a67d8811fefb2a85458a7024d4ad3cf8d5a14a06373b0c47d529cd30eef1419c037f7e629074addff9be87f0aa1df4b28cfc57222eb22112efa89d492a0627d51c14b04fead362acc331bb939c6d5440521af706d9648e4f3c259a3814a3be31ec3f254da49603a909062a30873eb31a2b0bdd8e57eec816ff7ca4da3bead0ce12afb62f37e348f0843d006a3fd7ba9911efb3bf4bcb00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004b57d5b27ba8d2936ca6e59830fcd968cddaab16000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006411739da1c40b106f8511de5d1fac00000000000000000000000074211ca76d4cdd26c143e8ffd74469a04ae4e43b0000000000000000000000000000000000000000000000000000000000000e830000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000205466db74c00000000000000000000000000000000000000000000000000000000000635484050000000000000000000000000000000000000000000000000000000063c394cf00000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000fa8e43e85fdc8d61afede11524a97afa00000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
	calldata, _ = hex.DecodeString(calldataStr)
	var executions []blur.Execution
	if method, ok := iBlurProxyAbi.Methods["bulkExecute"]; ok {
		params, err := method.Inputs.UnpackValues(calldata[4:])
		if err != nil {
			log.Fatal(err)
		}
		require.Equal(v2.T(), 1, len(params))
		executions, err = ParseExecutions(params[0])
		for i, _ := range executions {
			executions[i].Buy.Order.Trader = v2.BlurProxyAddr
		}
	}
	// encode data
	callDataBlur, err = iBlurProxyAbi.Pack("bulkExecute", executions)
	require.Equal(v2.T(), nil, err)
	fmt.Println("encode executions: " + hex.EncodeToString(callDataBlur))
	value, ok = big.NewInt(0).SetString("47300000000000000", 10)
	require.Equal(v2.T(), true, ok)
	auth.Value = value

	callDataBlur, err = blurProxy.Pack("bulkExecute", executions, recipient)
	require.Equal(v2.T(), nil, err)
	_, err = v2.Forwarder.Forward(auth, v2.BlurProxyAddr, callDataBlur)
	require.Equal(v2.T(), nil, err)
	calldata, err = forwardAbi.Pack("forward", v2.BlurProxyAddr, callDataBlur)
	require.Equal(v2.T(), nil, err)
	fmt.Printf("final build call data n items blur: %v \n\n", hex.EncodeToString(calldata))

	// buy 1 opensea - 1 blur

	// buy 2 openseas

}

func ParseInput(input interface{}) (*blur.Input, error) {
	parseRes, ok := input.(struct {
		Order struct {
			Trader         common.Address `json:"trader"`
			Side           uint8          `json:"side"`
			MatchingPolicy common.Address `json:"matchingPolicy"`
			Collection     common.Address `json:"collection"`
			TokenId        *big.Int       `json:"tokenId"`
			Amount         *big.Int       `json:"amount"`
			PaymentToken   common.Address `json:"paymentToken"`
			Price          *big.Int       `json:"price"`
			ListingTime    *big.Int       `json:"listingTime"`
			ExpirationTime *big.Int       `json:"expirationTime"`
			Fees           []struct {
				Rate      uint16         `json:"rate"`
				Recipient common.Address `json:"recipient"`
			} `json:"fees"`
			Salt        *big.Int `json:"salt"`
			ExtraParams []byte   `json:"extraParams"`
		} `json:"order"`
		V                uint8    `json:"v"`
		R                [32]byte `json:"r"`
		S                [32]byte `json:"s"`
		ExtraSignature   []byte   `json:"extraSignature"`
		SignatureVersion uint8    `json:"signatureVersion"`
		BlockNumber      *big.Int `json:"blockNumber"`
	})
	if !ok {
		return nil, errors.New("pares input got error")
	}
	var result *blur.Input
	temporaryVariable, _ := json.Marshal(parseRes)
	err := json.Unmarshal(temporaryVariable, &result)
	if err != nil {
		return nil, err
	}
	return result, nil
}

func ParseExecutions(executions interface{}) ([]blur.Execution, error) {
	parseRes, ok := executions.([]struct {
		Sell struct {
			Order struct {
				Trader         common.Address `json:"trader"`
				Side           uint8          `json:"side"`
				MatchingPolicy common.Address `json:"matchingPolicy"`
				Collection     common.Address `json:"collection"`
				TokenId        *big.Int       `json:"tokenId"`
				Amount         *big.Int       `json:"amount"`
				PaymentToken   common.Address `json:"paymentToken"`
				Price          *big.Int       `json:"price"`
				ListingTime    *big.Int       `json:"listingTime"`
				ExpirationTime *big.Int       `json:"expirationTime"`
				Fees           []struct {
					Rate      uint16         `json:"rate"`
					Recipient common.Address `json:"recipient"`
				} `json:"fees"`
				Salt        *big.Int `json:"salt"`
				ExtraParams []byte   `json:"extraParams"`
			} `json:"order"`
			V                uint8    `json:"v"`
			R                [32]byte `json:"r"`
			S                [32]byte `json:"s"`
			ExtraSignature   []byte   `json:"extraSignature"`
			SignatureVersion uint8    `json:"signatureVersion"`
			BlockNumber      *big.Int `json:"blockNumber"`
		} `json:"sell"`
		Buy struct {
			Order struct {
				Trader         common.Address `json:"trader"`
				Side           uint8          `json:"side"`
				MatchingPolicy common.Address `json:"matchingPolicy"`
				Collection     common.Address `json:"collection"`
				TokenId        *big.Int       `json:"tokenId"`
				Amount         *big.Int       `json:"amount"`
				PaymentToken   common.Address `json:"paymentToken"`
				Price          *big.Int       `json:"price"`
				ListingTime    *big.Int       `json:"listingTime"`
				ExpirationTime *big.Int       `json:"expirationTime"`
				Fees           []struct {
					Rate      uint16         `json:"rate"`
					Recipient common.Address `json:"recipient"`
				} `json:"fees"`
				Salt        *big.Int `json:"salt"`
				ExtraParams []byte   `json:"extraParams"`
			} `json:"order"`
			V                uint8    `json:"v"`
			R                [32]byte `json:"r"`
			S                [32]byte `json:"s"`
			ExtraSignature   []byte   `json:"extraSignature"`
			SignatureVersion uint8    `json:"signatureVersion"`
			BlockNumber      *big.Int `json:"blockNumber"`
		} `json:"buy"`
	})
	if !ok {
		return nil, errors.New("pares input got error")
	}
	var result []blur.Execution
	temporaryVariable, _ := json.Marshal(parseRes)
	err := json.Unmarshal(temporaryVariable, &result)
	if err != nil {
		return nil, err
	}
	return result, nil
}
